# Render deployment config — https://render.com/docs/blueprint-spec
# Deploy this entire file by connecting your GitHub repo to Render.
# Creates: 1 Web Service (API) + 1 Cron Job (daily pipeline)
#
# NOTE: Persistent disk must be added manually in the Render dashboard after
# the first deploy (Disks > Add Disk, mount at /data, 1GB).
# Until then, DB_PATH defaults to a local path inside the service container.

services:
  # ── Backend API ─────────────────────────────────────────────────────────────
  - type: web
    name: baseline-api
    runtime: node
    rootDir: backend
    buildCommand: npm install
    startCommand: node src/index.js
    healthCheckPath: /health
    plan: free

    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: DB_PATH
        value: /data/baseline.db

      # ── Set these in the Render dashboard (not here — keep secrets out of git)
      - key: OPENAI_API_KEY
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USER_AGENT
        value: Baseline/1.0
      - key: SERPAPI_KEY
        sync: false
      - key: YOUTUBE_API_KEY
        sync: false
      - key: ADMIN_SECRET
        sync: false
      - key: ALLOWED_ORIGINS
        sync: false

  # ── Daily cron job ──────────────────────────────────────────────────────────
  # Runs at 11:00 UTC (6:00 AM Eastern) every day
  - type: cron
    name: baseline-daily-pipeline
    runtime: node
    rootDir: backend
    buildCommand: npm install
    schedule: "0 11 * * *"
    startCommand: node src/scheduler/runDaily.js

    envVars:
      - key: NODE_ENV
        value: production
      - key: DB_PATH
        value: /data/baseline.db
      - key: OPENAI_API_KEY
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USER_AGENT
        value: Baseline/1.0
      - key: SERPAPI_KEY
        sync: false
      - key: YOUTUBE_API_KEY
        sync: false
